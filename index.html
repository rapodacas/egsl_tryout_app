<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Softball Tryout App</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  body {
    margin: 0;
    padding: 0;
    background: #f2f2f7;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    overflow-x: hidden;
    /* font-size: 40px; */
  }
input, textarea, label, .player-name, .section-title { font-size: 3.0rem; }
  .hidden {
    display: none;
  }

  /* Start Screen */
  #teamSelectScreen {
    padding: 20px 16px;
  }

  #teamSelectScreen h1 {
    font-size: 1.4rem;
    margin-bottom: 12px;
  }

  .team-list {
    margin-top: 10px;
    margin-bottom: 16px;
  }

  .team-item {
    padding: 10px 12px;
    border-radius: 10px;
    background: #fff;
    margin-bottom: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .team-item span {
    font-size: 0.95rem;
    font-weight: 600;
  }

  .team-empty {
    font-size: 0.9rem;
    color: #777;
    font-style: italic;
  }

  .team-actions {
    margin-top: 10px;
  }

  .team-actions input {
    width: 100%;
    padding: 8px;
    border-radius: 10px;
    border: 1px solid #ccc;
    font-size: 0.9rem;
    margin-bottom: 8px;
  }

  .team-actions button {
    width: 100%;
    padding: 8px;
    border-radius: 10px;
    border: none;
    background: #007aff;
    color: #fff;
    font-size: 0.9rem;
  }

  /* Top Bar */
  .top-bar {
    display: flex;
    flex-direction: column;
    gap: 6px;
    padding: 10px 12px;
    background: #fff;
    border-bottom: 1px solid #ddd;
    position: sticky;
    top: 0;
    z-index: 10;
  }

  .top-row {
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .player-name {
    font-size: 2.0rem;
    font-weight: 700;
  }

  .player-controls {
    text-align:center;
  }
  .player-controls button {
    padding: 6px 6px;
    border-radius: 8px;
    border: none;
    background: #007aff;
    color: white;
    font-size: 1.7rem;
    margin-left: 4px;
  }

  /* Summary Bar */
  .summary-bar-container {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .summary-progress-outer {
    width: 100%;
    height: 8px;
    border-radius: 999px;
    background: #e0e0e0;
    overflow: hidden;
  }

  .summary-progress-inner {
    height: 100%;
    width: 0%;
    border-radius: 999px;
    background: #34c759;
    transition: width 0.2s ease-out;
  }

  .summary-text {
    font-size: 1rem;
    color: #555;
    display: flex;
    justify-content: space-between;
  }

  /* Card */
  .card {
    background: white;
    margin: 6px;
    padding: 8px;
    border-radius: 14px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }

  .field {
    margin-bottom: 10px;
    padding: 8px;
    border-radius: 10px;
    border: 1px solid #ddd;
    background: #fafafa;
  }

  label {
    font-size: 1rem;
    font-weight: 600;
    display: block;
    margin-bottom: 4px;
  }

  input, textarea {
    width: 100%;
    padding: 6px 8px;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 1.1rem;
    box-sizing: border-box;
    background: #fff;
  }

  textarea {
    min-height: 60px;
  }


  /* Profile Photo */
  .profile-row {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    margin-bottom: 12px;
  }

  .profile-pic-wrapper {
    width: 145px;
    height: 145px;
    border-radius: 50%;
    overflow: hidden;
    border: 2px solid #ccc;
    background: #eaeaea;
    flex-shrink: 0; /* prevents distortion */
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
  }

  .profile-pic-wrapper img {
    width: 100%;
    height: 100%;
    object-fit: cover; /* keeps aspect ratio while filling the circle */
  }

  #photoInput {
    display: none;
  }

  /* Throws/Bats pill buttons */
  .throws-group {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
  }

  .throws-option {
    flex: 1;
    text-align: center;
    padding: 6px 4px;
    border-radius: 999px;
    border: 1px solid #ccc;
    font-size: 0.8rem;
    background: #fff;
    cursor: pointer;
    user-select: none;
  }

  .throws-option.selected {
    background: #007aff;
    color: #fff;
    border-color: #007aff;
  }

  /* All Players View */
  #allPlayersView {
    display: none;
    padding: 12px;
  }

  .players-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
  }

  .players-table th,
  .players-table td {
    padding: 8px;
    border-bottom: 1px solid #ddd;
  }

  .players-table tr {
    cursor: pointer;
  }

  .players-table tr:hover {
    background: #f0f0f0;
  }
    /* Center all table content */ 
  .players-table th, .players-table td { 
    text-align: center; 
    }
  /* Alternating row colors */ 
  .players-table tbody tr:nth-child(odd) { background: #fafafa; } 
  .players-table tbody tr:nth-child(even) { background: #ffffff; }
  /* Sortable column cursor */ .players-table th { cursor: pointer; user-select: none; }
  /* Highlight sorted column */ .players-table th.sorted-asc::after { content: " ‚ñ≤"; font-size: 0.7rem; } 
  .players-table th.sorted-desc::after { content: " ‚ñº"; font-size: 0.7rem; }
  /* Left-align only the Player column */
  .players-table td:first-child, .players-table th:first-child {
      text-align: left; padding-left: 8px; 
      /* optional: adds breathing room */ 
  }

  /* PLAYER NAVIGATION BAR */
  #playerNavBar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #ffffff;
    padding: 8px 12px;
    border-bottom: 1px solid #d0d0d5;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  }

  #playerNavBar .nav-arrow {
    background: #f2f2f7;
    border: 1px solid #c8c8cc;
    border-radius: 6px;
    padding: 6px 12px;
    font-size: 20px;
    cursor: pointer;
    min-width: 40px;
    transition: background 0.15s ease;
  }

  #playerNavBar .nav-arrow:active {
    background: #e0e0e5;
  }

  #playerNavBar .nav-arrow:disabled {
    opacity: 0.35;
    cursor: default;
  }

  #navPlayerTitle {
    flex: 1;
    text-align: center;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    user-select: none;
  }

  #navPlayerTitle:active {
    opacity: 0.6;
  }

  /* CATEGORY CARD WRAPPER */
  .category-card {
    background: #ffffff;
    border: 1px solid #d0d0d5;
    border-radius: 10px;
    padding: 6px;
    margin-bottom: 10px;
  }
  
  /* CATEGORY TITLE */
  .section-title {
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: 6px;
  }
  
  /* SWIPABLE PANEL */
  .progress-panel {
    background: #fafafa;
    border: 1px solid #d0d0d5;
    border-radius: 8px;
    padding: 12px;
    user-select: none;
    transition: transform 0.15s ease;
  }
  
  /* SWIPE ANIMATION STATES */
  .progress-panel.swipe-left {
    transform: translateX(-20px);
  }
  .progress-panel.swipe-right {
    transform: translateX(20px);
  }
  /* UNIFIED RECORD UI */
  .progress-record {
    display: flex;
    flex-direction: column;
    gap: 14px; 
  }
  /* RATING GRID (CIRCLES) */
  .rating-group-grid {
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 8px;
  }
  .rating-item {
    display: flex;
    flex-direction: column;
  }
  .rating-label {
    font-size: 13px;
    margin-bottom: 4px;
    color: #444;
  }
  /* CIRCLE UI */
  .rating-circles {
    display: flex;
    gap: 6px;
  }

  .circle {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    border: 1px solid #aaa;
    background: #eaeaea;
    transition: background 0.15s ease, border-color 0.15s ease;
  }

  .circle.active-blue {
    background-color: #007bff;
    border-color: #007bff;
  }

  .circle.active-green {
    background-color: #28a745;
    border-color: #28a745;
  }

  /* PROGRESS META */
  .progress-meta { 
    display: flex;
    justify-content: space-between;
    font-size: 13px;
    color: #555;
    padding-top: 4px;
    border-top: 1px solid #ddd; 
  }
  
  .progress-body {
    display: flex;
    flex-direction: column-reverse;
  }

  .attachments-indicator {
    display: flex;
    align-items: center;
    gap: 4px;
    cursor: pointer;
    opacity: 0.75;
    transition: opacity 0.15s ease;
  }

  .attachments-indicator:hover {
    opacity: 1;
  }

  .attachments-icon {
    width: 16px;
    height: 16px;
  }

  .attachments-count {
    font-size: 12px;
    color: #444;
  }

  .attachments-indicator.disabled {
    opacity: 0.3;
    pointer-events: none;
  }

</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
</head>

<body>

<!-- TEAM SELECTION SCREEN -->
<div id="teamSelectScreen">
  <h1>Select or create a team</h1>
  <div id="teamList" class="team-list"></div>

  <div class="team-actions">
    <input type="text" id="newTeamName" placeholder="New team name (e.g., 12U A)">
    <button onclick="createTeam()">Create New Team</button>
  </div>
  <div class="team-actions">
    <button onclick="triggerCSVImport()">Import Team CSV</button>
    <input type="file" id="teamCSVInput" accept=".csv" style="display:none">
  </div>

</div>

<!-- MAIN APP -->
<div id="mainApp" class="hidden">

  <!-- TOP BAR -->
  <div class="top-bar">
    <div class="top-row">
      <div class="player-controls">
        <button onclick="toggleAllPlayers()">All Players</button>
        <!-- <button onclick="addPlayer()">+</button>
        <button onclick="deletePlayer()" style="font-size: 1.5rem;">üóë</button>
        <button onclick="exportCSV()">CSV</button>
        <button onclick="exportPDF()">PDF</button> -->
        <button onclick="toggleTeamSummary()">Summary</button>

      </div>
    </div>
  </div>

  <!-- ALL PLAYERS VIEW -->
  <div id="allPlayersView">
    <h2>All Players</h2>
    <table class="players-table" id="playersTable">
        <thead> 
            <tr> 
                <th>#</th>
                <th>Name</th>
                <th>ü¶Øüí•</th>
                <th>ü•é</th>
                <th>üèÉ</th>
                <th>Overall</th>
                <th>%</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
  </div>

  <!-- TEAM SUMMARY VIEW -->
  <div id="teamSummaryView" style="display:none; padding: 12px;">
    <h2>Team Summary</h2>
    <table class="players-table" id="teamSummaryTable">
      <thead>
        <tr>
          <th>Category</th>
          <th>Average</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- PLAYER CARD -->
  <div class="swipe-container" id="swipeArea">
    
    <div class="card" id="playerCard">
      <!-- PLAYER NAVIGATION BAR -->
      <div id="playerNavBar">
        <button class="nav-arrow" id="navPrevPlayer">‚Äπ</button>

        <div id="navPlayerTitle">
          <span id="navPlayerText">Player 1 of 1</span>
        </div>

        <button class="nav-arrow" id="navNextPlayer">‚Ä∫</button>
      </div>
      <div class="player-name" id="playerNameDisplay">Player 1</div>
      <div class="summary-bar-container">
        <div class="summary-progress-outer">
          <div class="summary-progress-inner" id="summaryProgress"></div>
        </div>
        <div class="summary-text">
          <span id="summaryScore">Score: 0</span>
          <span id="summaryAvg">Avg: 0.0</span>
          <span id="summaryCompletion">0%</span>
        </div>
      </div>
      <!-- PROFILE + NAME + THROWS -->
      <div class="profile-row">
  
        <!-- Profile Photo -->
        <div class="profile-pic-wrapper" id="profilePicWrapper">
          <img id="profilePic" src="" alt="">
        </div>
        <input type="file" id="photoInput" accept="image/*" capture="environment">

        <!-- Name + Throws -->
        <div>
          <div class="field">
            <label>Name</label>
            <input type="text" data-field="name">
          </div>

          <div class="field">
            <label>Throws/Bats</label>
            <div class="throws-group" id="throwsGroup">
              <div class="throws-option" data-throws-value="R/R">R/R</div>
              <div class="throws-option" data-throws-value="R/L">R/L</div>
              <div class="throws-option" data-throws-value="L/R">L/R</div>
              <div class="throws-option" data-throws-value="L/L">L/L</div>
            </div>
          </div>
        </div>

      </div>

      <!-- <div class="section-title">Notes</div> -->
      <div class="field">
        <textarea data-field="notes" placeholder="Strengths, weaknesses, recommended positions..."></textarea>
      </div>

      <!-- RATINGS -->
      <div class="category-card" id="card-hitting">
        <div class="section-title">Hitting</div>
        <!-- SWIPABLE RECORD CONTAINER -->
        <div class="progress-panel swipe-zone" id="progress-hitting">
          <!-- ONE unified record UI (rendered dynamically) -->
          <div class="progress-record" id="hittingRecord">
            <!-- Rating circles (same UI for all sessions) -->
            <div class="rating-group-grid">
              <div class="rating-item">
                <div class="rating-label">Swing</div>
                <div class="rating-circles" data-field="swing">
                  <div class="circle" data-level="1"></div>
                  <div class="circle" data-level="2"></div>
                  <div class="circle" data-level="3"></div>
                  <div class="circle" data-level="4"></div>
                </div>
              </div>

              <div class="rating-item">
                <div class="rating-label">Contact</div>
                <div class="rating-circles" data-field="contact">
                  <div class="circle" data-level="1"></div>
                  <div class="circle" data-level="2"></div>
                  <div class="circle" data-level="3"></div>
                  <div class="circle" data-level="4"></div>
                </div>
              </div>

              <div class="rating-item">
                <div class="rating-label">Power</div>
                <div class="rating-circles" data-field="power">
                  <div class="circle" data-level="1"></div>
                  <div class="circle" data-level="2"></div>
                  <div class="circle" data-level="3"></div>
                  <div class="circle" data-level="4"></div>
                </div>
              </div>
            </div>
            <!-- Meta info for this session -->
            <div class="progress-meta">
              <span id="hittingRecordIndex">Session 1 of 1</span>
              <span id="hittingRecordDate">Jan 22, 2026</span>
              <div class="attachments-indicator" id="hittingAttachments"></div>
            </div>
          </div> <!-- end progress-record -->
        </div> <!-- end progress-panel -->
      </div> <!-- end category-card -->

      <div class="category-card" id="card-fielding">

        <div class="section-title">Fielding</div>
        <div class="progress-panel" id="progress-fielding">
          <div class="progress-record" id="fieldingRecord">
            <div class="rating-group-grid">
              <div class="rating-item">
                <div class="rating-label">Glove</div>
                <div class="rating-circles" data-field="glove">
                  <div class="circle" data-level="1"></div>
                  <div class="circle" data-level="2"></div>
                  <div class="circle" data-level="3"></div>
                  <div class="circle" data-level="4"></div>
                </div>
              </div>

              <div class="rating-item">
                <div class="rating-label">Arm</div>
                <div class="rating-circles" data-field="arm">
                  <div class="circle" data-level="1"></div>
                  <div class="circle" data-level="2"></div>
                  <div class="circle" data-level="3"></div>
                  <div class="circle" data-level="4"></div>
                </div>
              </div>

              <div class="rating-item">
                <div class="rating-label">Footwork</div>
                <div class="rating-circles" data-field="footwork">
                  <div class="circle" data-level="1"></div>
                  <div class="circle" data-level="2"></div>
                  <div class="circle" data-level="3"></div>
                  <div class="circle" data-level="4"></div>
                </div>
              </div>
            </div>
            <div class="progress-meta">
              <span id="fieldingRecordIndex">Session 1 of 1</span>
              <span id="fieldingRecordDate">Jan 22, 2026</span>
              <div class="attachments-indicator" id="fieldingAttachments"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="category-card" id="card-intangibles">

        <div class="section-title">Speed & Intangibles</div>
        <div class="progress-panel" id="progress-intangibles">
          <div class="progress-record" id="intangiblesRecord">
            <div class="rating-group-grid">
              <div class="rating-item">
                <div class="rating-label">Speed</div>
                <div class="rating-circles" data-field="speed">
                  <div class="circle" data-level="1"></div>
                  <div class="circle" data-level="2"></div>
                  <div class="circle" data-level="3"></div>
                  <div class="circle" data-level="4"></div>
                </div>
              </div>

              <div class="rating-item">
                <div class="rating-label">Hustle</div>
                <div class="rating-circles" data-field="hustle">
                  <div class="circle" data-level="1"></div>
                  <div class="circle" data-level="2"></div>
                  <div class="circle" data-level="3"></div>
                  <div class="circle" data-level="4"></div>
                </div>
              </div>

              <div class="rating-item">
                <div class="rating-label">Coachability</div>
                <div class="rating-circles" data-field="coachability">
                  <div class="circle" data-level="1"></div>
                  <div class="circle" data-level="2"></div>
                  <div class="circle" data-level="3"></div>
                  <div class="circle" data-level="4"></div>
                </div>
              </div>
            </div>

            <div class="progress-meta">
              <span id="intangiblesRecordIndex">Session 1 of 1</span>
              <span id="intangiblesRecordDate">Jan 22, 2026</span>
              <div class="attachments-indicator" id="intangiblesAttachments"></div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>
<script>
/* GLOBAL STATE */
let currentTeamKey = null;
let players = [];
let current = 0;
let sortState = { column: null, direction: 1 };
let sortedPlayerOrder = [];
let progressState = {
  hitting: { index: 0 },
  fielding: { index: 0 },
  intangibles: { index: 0 }
};

function toggleTeamSummary() {
  const summary = document.getElementById("teamSummaryView");
  const card = document.getElementById("playerCard");
  const list = document.getElementById("allPlayersView");

  if (summary.style.display === "none" || summary.style.display === "") {
    buildTeamSummary();
    hideAllViews();
    summary.style.display = "block";
  } else {
    hideAllViews();
    card.style.display = "block";
  }
}

function buildTeamSummary() {
  const tbody = document.querySelector("#teamSummaryTable tbody");
  tbody.innerHTML = "";

  // Subcategories (individual ratings)
  const categories = {
    swing: "Swing",
    contact: "Contact",
    power: "Power",
    glove: "Glove",
    arm: "Arm",
    footwork: "Footwork",
    speed: "Speed",
    hustle: "Hustle",
    coachability: "Coachability"
  };

  // Grouped categories
  const groups = {
    hitting: ["swing", "contact", "power"],
    fielding: ["glove", "arm", "footwork"],
    intangibles: ["speed", "hustle", "coachability"]
  };

  function avgOf(fields) {
    let sum = 0, count = 0;
    players.forEach(p => {
      fields.forEach(f => {
        if (p[f] >= 1 && p[f] <= 4) {
          sum += p[f];
          count++;
        }
      });
    });
    return count ? (sum / count) : 0;
  }

  // ‚≠ê SORTED SUBCATEGORIES FIRST
  const sortedSubcats = Object.entries(categories)
    .sort((a, b) => a[1].localeCompare(b[1])); // sort by label

  sortedSubcats.forEach(([key, label]) => {
    const avg = avgOf([key]).toFixed(2);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${label}</td>
      <td>${avg}</td>
    `;
    tbody.appendChild(tr);
  });

  // ‚≠ê SORTED GROUPED CATEGORIES NEXT
  const groupLabels = {
    hitting: "Hitting",
    fielding: "Fielding",
    intangibles: "Speed & Intangibles"
  };

  const sortedGroups = Object.keys(groups)
    .sort((a, b) => groupLabels[a].localeCompare(groupLabels[b]));

  sortedGroups.forEach(key => {
    const avg = avgOf(groups[key]).toFixed(2);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><strong>${groupLabels[key]}</strong></td>
      <td><strong>${avg}</strong></td>
    `;
    tbody.appendChild(tr);
  });

  // ‚≠ê OVERALL TEAM AVERAGE
  const allFields = Object.keys(categories);
  const overall = avgOf(allFields).toFixed(2);

  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td><strong>Overall Team Average</strong></td>
    <td><strong>${overall}</strong></td>
  `;
  tbody.appendChild(tr);

  // ‚≠ê PLAYER COUNT
  const tr2 = document.createElement("tr");
  tr2.innerHTML = `
    <td><strong>Total Players</strong></td>
    <td><strong>${players.length}</strong></td>
  `;
  tbody.appendChild(tr2);
}

/* TEAM MANAGEMENT */

function getTeamKeys() {
  const keys = [];
  for (let i = 0; i < localStorage.length; i++) {
    const k = localStorage.key(i);
    if (k && k.startsWith("team_")) {
      keys.push(k);
    }
  }
  return keys.sort();
}

function renderTeamList() {
  const container = document.getElementById("teamList");
  container.innerHTML = "";

  const keys = getTeamKeys();
  if (keys.length === 0) {
    const empty = document.createElement("div");
    empty.className = "team-empty";
    empty.textContent = "No teams yet. Create one below.";
    container.appendChild(empty);
    return;
  }

  keys.forEach(key => {
    const teamName = key.replace("team_", "");
    const div = document.createElement("div");
    div.className = "team-item";
    const span = document.createElement("span");
    span.textContent = teamName;

    div.appendChild(span);
    div.addEventListener("click", () => {
      selectTeam(key);
    });

    container.appendChild(div);
  });
}

function createTeam() {
  const input = document.getElementById("newTeamName");
  const name = input.value.trim();
  if (!name) return;

  const key = "team_" + name;
  if (!localStorage.getItem(key)) {
    localStorage.setItem(key, JSON.stringify([{}]));
  }
  input.value = "";
  renderTeamList();
  seedTeam(name);
}

function selectTeam(key) {
  currentTeamKey = key;
  const data = localStorage.getItem(currentTeamKey);
  players = data ? JSON.parse(data) : [{}];
  if (!Array.isArray(players) || players.length === 0) {
    players = [{}];
  }
  current = 0;

  document.getElementById("teamSelectScreen").classList.add("hidden");
  document.getElementById("mainApp").classList.remove("hidden");

  loadPlayer();
  buildPlayersTable();
  hideAllViews();
  document.getElementById("allPlayersView").style.display = "block";
}

function showTeamSelect() {
  document.getElementById("mainApp").classList.add("hidden");
  document.getElementById("teamSelectScreen").classList.remove("hidden");
  renderTeamList();
}

function triggerCSVImport() {
  document.getElementById("teamCSVInput").click();
}
document.getElementById("teamCSVInput").addEventListener("change", function () {
  const file = this.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function (e) {
    importTeamFromCSV(e.target.result, file.name);
  };
  reader.readAsText(file);
});
function importTeamFromCSV(csvText, filename) {
  const lines = csvText.trim().split(/\r?\n/);
  if (lines.length < 2) {
    alert("CSV appears empty or invalid.");
    return;
  }

  const headers = lines[0].split(",").map(h => h.trim());
  const players = [];

  for (let i = 1; i < lines.length; i++) {
    const raw = lines[i].trim();
    if (!raw) continue;

    const cols = raw.split(",");
    const p = {};

    headers.forEach((h, idx) => {
      p[h] = cols[idx] ? cols[idx].trim() : "";
    });

    // Normalize fields your app expects
    p.name = p.name || p.Name || "";
    p.throws = p.throws || p.Throws || "";
    p.notes = p.notes && p.notes.replace(/"/g, '') || "";

    // Convert ratings to numbers
    ["swing","contact","power","glove","arm","footwork","speed","hustle","coachability"]
      .forEach(f => p[f] = Number(p[f]) || 0);

    // Photo (Base64) if included
    if (p.photo) p.photo = p.photo;

    players.push(p);
  }

  // Team name from filename
  const teamName = filename.replace(".csv", "");
  const key = "team_" + teamName;

  localStorage.setItem(key, JSON.stringify(players));

  alert(`Imported ${players.length} players into team: ${teamName}`);

  // Refresh team list
  renderTeamList();
}

/* SAVE CURRENT TEAM */
function save() {
  if (!currentTeamKey) return;
  localStorage.setItem(currentTeamKey, JSON.stringify(players));
}

/* SUMMARY BAR */
function updateSummary() {
  const p = players[current] || {};
  const fields = [
    "swing","contact","power",
    "glove","arm","footwork",
    "speed","hustle","coachability"
  ];

  let sum = 0, count = 0;
  fields.forEach(f => {
    if (p[f] >= 1 && p[f] <= 4) {
      sum += p[f];
      count++;
    }
  });

  const avg = count ? sum / count : 0;
  const percent = (sum/36*100).toFixed(2);

  document.getElementById("summaryScore").textContent = "Score: " + sum;
  document.getElementById("summaryAvg").textContent = "Category Avg: " + avg.toFixed(1);
  document.getElementById("summaryCompletion").textContent = Math.round(percent) + "%";
  document.getElementById("summaryProgress").style.width = percent + "%";
}

/* LOAD PLAYER */
function loadPlayer() {
  const p = players[current] || {};
  if (!p.progress) {
    p.progress = defaultProgressFor(p);
    save(); // persist upgrade
    progressState.hitting.index = 0;
    progressState.fielding.index = 0;
    progressState.intangibles.index = 0;
  }

  document.getElementById("playerNameDisplay").textContent = p.name || `Player ${current + 1}`;

  // Text inputs / textarea
  document.querySelectorAll("input[data-field], textarea[data-field]").forEach(el => {
    const field = el.getAttribute("data-field");
    el.value = p[field] || "";
  });

  // Rating circles
  document.querySelectorAll(".rating-circles").forEach(group => {
    const field = group.getAttribute("data-field");
    group.querySelectorAll(".circle").forEach(c => {
      c.classList.remove("selected");
      const level = parseInt(c.getAttribute("data-level"), 10);
      if (p[field] === level) {
        c.classList.add("selected");
      }
    });
  });

  // Throws/Bats pill buttons
  const throwsValue = p.throws || "";
  document.querySelectorAll(".throws-option").forEach(opt => {
    const val = opt.getAttribute("data-throws-value");
    if (val === throwsValue) opt.classList.add("selected");
    else opt.classList.remove("selected");
  });

  // Profile photo
  const profilePic = document.getElementById("profilePic");
  if (p.photo) {
    profilePic.src = p.photo;
  } else {
    profilePic.src = "";
  }

  updateSummary();

  // Re-Initialize Progress Panel
  progressState.hitting.index = 0;
  progressState.fielding.index = 0;
  progressState.intangibles.index = 0;

  renderProgressPanel("hitting");
  renderProgressPanel("fielding");
  renderProgressPanel("intangibles");

}

/* ADD PLAYER */
function addPlayer() {
  players.push({});
  current = players.length - 1;
  save();
  loadPlayer();
}

/* DELETE PLAYER */
function deletePlayer() {
  if (players.length === 1) return;
  players.splice(current, 1);
  current = Math.max(0, current - 1);
  save();
  loadPlayer();
}

/* INPUT HANDLERS (name, notes) */
document.addEventListener("input", e => {
  const el = e.target;
  if (!el.matches("input[data-field], textarea[data-field]")) return;

  const field = el.getAttribute("data-field");
  if (!players[current]) players[current] = {};
  players[current][field] = el.value;
  save();
  loadPlayer();
});

/* RATING HANDLERS */
document.addEventListener("click", e => {
  // Rating circles
  const circle = e.target.closest(".circle");
  if (circle) {
    const group = circle.closest(".rating-circles");
    if (group) {
      const field = group.getAttribute("data-field");
      const level = parseInt(circle.getAttribute("data-level"), 10);
      if (!players[current]) players[current] = {};
      players[current][field] = level;
      save();

      group.querySelectorAll(".circle").forEach(c => c.classList.remove("selected"));
      circle.classList.add("selected");
      updateSummary();
    }
  }

  // Throws/Bats pill buttons
  const throwsOption = e.target.closest(".throws-option");
  if (throwsOption) {
    const value = throwsOption.getAttribute("data-throws-value");
    if (!players[current]) players[current] = {};
    players[current].throws = value;
    save();

    document.querySelectorAll(".throws-option").forEach(opt => opt.classList.remove("selected"));
    throwsOption.classList.add("selected");
  }
});

/* SWIPE NAVIGATION */
document.getElementById("navPrevPlayer").addEventListener("click", () => {
  changePlayer(-1);
});

document.getElementById("navNextPlayer").addEventListener("click", () => {
  changePlayer(1);
});

document.getElementById("navPlayerTitle").addEventListener("click", () => {
  openAllPlayersSelector();
});

function changePlayer(direction) {
  const currentSortedIndex = sortedPlayerOrder.indexOf(current);
  const newSortedIndex = currentSortedIndex + direction;

  if (newSortedIndex < 0 || newSortedIndex >= sortedPlayerOrder.length) return;

  current = sortedPlayerOrder[newSortedIndex];
  loadPlayer();
  updateNavBar();
}

function updateNavBar() {
  const sortedIndex = sortedPlayerOrder.indexOf(current);
  const title = document.getElementById("navPlayerText");

  title.textContent = `Player ${sortedIndex + 1} of ${sortedPlayerOrder.length}`;

  document.getElementById("navPrevPlayer").disabled = sortedIndex === 0;
  document.getElementById("navNextPlayer").disabled = sortedIndex === sortedPlayerOrder.length - 1;
}

function openAllPlayersSelector() {
  // Build the table fresh
  buildPlayersTable();
  hideAllViews();
  document.getElementById("allPlayersView").style.display = "block";
  // Highlight the current player
  highlightCurrentPlayerInList();
}

function highlightCurrentPlayerInList() {
  const rows = document.querySelectorAll("#playersTableBody tr");

  rows.forEach((row, index) => {
    if (index === current) {
      row.style.background = "#d0e7ff";
      row.style.fontWeight = "600";
    } else {
      row.style.background = "";
      row.style.fontWeight = "";
    }
  });
}

function hideAllViews() {
  document.getElementById("playerCard").style.display = "none";
  document.getElementById("allPlayersView").style.display = "none";
  const summary = document.getElementById("teamSummaryView");
  if (summary) summary.style.display = "none";
}

/* ALL PLAYERS VIEW */
function toggleAllPlayers() {
  const card = document.getElementById("playerCard");
  const list = document.getElementById("allPlayersView");

  if (list.style.display === "none" || list.style.display === "") {
    buildPlayersTable();
    hideAllViews();
    list.style.display = "block";
  } else {
    hideAllViews();
    card.style.display = "block";
  }
}

function buildPlayersTable() {
  const tbody = document.querySelector("#playersTable tbody");
  const thead = document.querySelector("#playersTable thead");
  tbody.innerHTML = "";

  const fields = [
    "swing","contact","power",
    "glove","arm","footwork",
    "speed","hustle","coachability"
  ];

  // Compute stats for each player
  const rows = players.map((p, index) => {
    const hittingFields = ["swing", "contact", "power"];
    const fieldingFields = ["glove", "arm", "footwork"];
    const intangiblesFields = ["speed", "hustle", "coachability"];

    function avgOf(list) {
      let s = 0, c = 0;
      list.forEach(f => {
        if (p[f] >= 1 && p[f] <= 4) {
          s += p[f];
          c++;
        }
      });
      return c ? s / c : 0;
    }

    // Category averages
    const hitting = avgOf(hittingFields);
    const fielding = avgOf(fieldingFields);
    const intangibles = avgOf(intangiblesFields);

    // Overall = sum of all 9 subcategories
    const allFields = [...hittingFields, ...fieldingFields, ...intangiblesFields];
    let overall = 0;
    allFields.forEach(f => {
      if (p[f] >= 1 && p[f] <= 4) {
        overall += p[f];
      }
    });

    // Percent = overall / 36
    const percent = overall / 36;

    return {
      index,
      seed: index + 1,
      name: p.name || `Player ${index + 1}`,
      hitting,
      fielding,
      intangibles,
      overall,
      percent
    };
  });
  
  // Apply sorting
  if (sortState.column) {
    rows.sort((a, b) => {
      const col = sortState.column;
      const dir = sortState.direction;
      
      if (typeof a[col] === "string") {
        return a[col].localeCompare(b[col]) * dir;
      }
      return (a[col] - b[col]) * dir;
    });
  }
  sortedPlayerOrder = rows.map(r => r.index);
  
  // Render rows
  rows.forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
        <td>${r.seed}</td>
        <td>${r.name}</td>
        <td>${r.hitting.toFixed(1)}</td>
        <td>${r.fielding.toFixed(1)}</td>
        <td>${r.intangibles.toFixed(1)}</td>
        <td>${r.overall}</td>
        <td>${Math.round(r.percent * 100)}%</td>
    `;

    tr.addEventListener("click", () => {
      current = r.index;
      updateNavBar();
      loadPlayer();
      hideAllViews();
      document.getElementById("playerCard").style.display = "block";
    });

    tbody.appendChild(tr);
  });

  // Make headers sortable
  const headers = thead.querySelectorAll("th");
  headers.forEach((th, i) => {
    const colMap = [
        "seed",
        "name",
        "hitting",
        "fielding",
        "intangibles",
        "overall",
        "percent"
    ];

    const col = colMap[i];

    th.onclick = () => {
      // Toggle direction if clicking same column
      if (sortState.column === col) {
        sortState.direction *= -1;
      } else {
        sortState.column = col;
        sortState.direction = 1;
      }

      // Clear previous sort indicators
      headers.forEach(h => h.classList.remove("sorted-asc", "sorted-desc"));

      // Add new indicator
      th.classList.add(sortState.direction === 1 ? "sorted-asc" : "sorted-desc");

      buildPlayersTable();
    };
  });
}

/* PDF EXPORT */
async function exportPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: "pt", format: "letter" });

  const teamName = currentTeamKey ? currentTeamKey.replace("team_", "") : "Team";
  let y = 40;

  doc.setFontSize(18);
  doc.text(`${teamName} ‚Äì Player Roster`, 40, y);
  y += 30;

  doc.setFontSize(12);

  for (let i = 0; i < players.length; i++) {
    const p = players[i];

    // Section header
    doc.setFontSize(14);
    doc.text(`${i + 1}. ${p.name || "Unnamed Player"}`, 40, y);
    y += 20;
    doc.setFontSize(12);

    // Photo
    if (p.photo) {
      try {
        doc.addImage(p.photo, "JPEG", 40, y, 80, 80);
      } catch (e) {
        console.warn("Image failed to load for PDF:", e);
      }
    }

    // Player info
    let infoY = y;
    if (p.photo) infoY += 90;

    doc.text(`Throws/Bats: ${p.throws || "-"}`, 140, y + 15);

    // Ratings
    const ratingFields = [
      ["Swing", p.swing],
      ["Contact", p.contact],
      ["Power", p.power],
      ["Glove", p.glove],
      ["Arm", p.arm],
      ["Footwork", p.footwork],
      ["Speed", p.speed],
      ["Hustle", p.hustle],
      ["Coachability", p.coachability]
    ];

    let ry = infoY;
    ratingFields.forEach(([label, val]) => {
      doc.text(`${label}: ${val || "-"}`, 40, ry);
      ry += 16;
    });

    // Notes
    if (p.notes) {
      ry += 10;
      doc.text("Notes:", 40, ry);
      ry += 14;

      const wrapped = doc.splitTextToSize(p.notes, 520);
      doc.text(wrapped, 40, ry);
      ry += wrapped.length * 14;
    }

    y = ry + 20;

    // Page break if needed
    if (y > 700) {
      doc.addPage();
      y = 40;
    }
  }

  doc.save(`${teamName}_players.pdf`);
}
  
/* CSV EXPORT */
function exportCSV() {
  if (!players || players.length === 0) return;

  const fields = [
    "name","throws",
    "swing","contact","power",
    "glove","arm","footwork",
    "speed","hustle","coachability",
    "notes"
    //,
    //"photo"   // NEW: include Base64 image
  ];

  const header = fields.join(",");
  const rows = players.map(p => {
    const player = p || {};
    return fields.map(field => {
      let value = player[field];

      // Ensure empty fields are blank
      if (value === undefined || value === null) value = "";

      // Escape quotes
      value = String(value).replace(/"/g, '""');

      // Wrap in quotes if needed
      if (value.includes(",") || value.includes("\n") || value.includes("\"")) {
        value = `"${value}"`;
      }

      return value;
    }).join(",");
  });

  const csv = [header, ...rows].join("\n");
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  const teamName = currentTeamKey ? currentTeamKey.replace("team_", "") : "team";
  a.href = url;
  a.download = teamName + "_players.csv";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function initProgressSwipeListeners() {
  setupSwipe("hitting");
  setupSwipe("fielding");
  setupSwipe("intangibles");
}

function defaultProgressFor(player) {
  return {
    hitting: [
      {
        date: new Date().toISOString().split("T")[0],
        swing: player.swing ?? 1,
        contact: player.contact ?? 1,
        power: player.power ?? 1,
        media: { attachments: [] }
      }
    ],
    fielding: [
      {
        date: new Date().toISOString().split("T")[0],
        glove: player.glove ?? 1,
        arm: player.arm ?? 1,
        footwork: player.footwork ?? 1,
        media: { attachments: [] }
      }
    ],
    intangibles: [
      {
        date: new Date().toISOString().split("T")[0],
        speed: player.speed ?? 1,
        hustle: player.hustle ?? 1,
        coachability: player.coachability ?? 1,
        media: { attachments: [] }
      }
    ]
  };
}

function setupSwipe(category) {
  const panel = document.getElementById(`progress-${category}`);

  let startX = 0;
  let endX = 0;
  let didMove = false;

  panel.addEventListener("touchstart", e => {
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
    didMove = false;
  });

  panel.addEventListener("touchmove", e => {
    const x = e.touches[0].clientX;
    const y = e.touches[0].clientY;
    
    endX = x;
    
    const dx = Math.abs(x - startX);
    const dy = Math.abs(y - startY);
    
    // Only count as movement if horizontal movement is intentional
    if (dx > 25 && dx > dy) {
      didMove = true;
    }
  });
  
  panel.addEventListener("touchend", e => {
    if (!didMove) return;

    const delta = endX - startX;
    if (Math.abs(delta) < 60) return;

    if (delta < 0) {
      handleSwipeLeft(category);
    } else {
      handleSwipeRight(category);
    }
  });

  function handleSwipeLeft(category) {
    const state = progressState[category];
    const records = players[current].progress[category];

    if (state.index === 0) {
      createNewProgressRecord(category);
    } else {
      state.index--;
    }

    animateSwipe(category, "left");
    renderProgressPanel(category);
  }

  function handleSwipeRight(category) {
    const state = progressState[category];
    const records = players[current].progress[category];

    if (state.index < records.length - 1) {
      state.index++;
      animateSwipe(category, "right");
      renderProgressPanel(category);
    }
  }
}

function animateSwipe(category, direction) {
  const panel = document.getElementById(`progress-${category}`);
  panel.classList.add(`swipe-${direction}`);

  setTimeout(() => {
    panel.classList.remove(`swipe-${direction}`);
  }, 150);
}

function createNewProgressRecord(category) {
  const player = players[current];
  const records = player.progress[category];

  const latest = records[0];

  const newRecord = {
    date: new Date().toISOString().split("T")[0],
    ...latest,
    media: { attachments: [] }
  };

  records.unshift(newRecord);
  progressState[category].index = 0;

  save();
}

function renderProgressPanel(category) {
  const player = players[current];
  const records = player.progress[category];
  const index = progressState[category].index;
  const record = records[index];

  const recordEl = document.getElementById(`${category}Record`);

  //
  // 1. EDITABLE vs READONLY
  //
  if (index === 0) {
    recordEl.classList.add("editable");
    recordEl.classList.remove("readonly");
  } else {
    recordEl.classList.add("readonly");
    recordEl.classList.remove("editable");
  }

  //
  // 2. UPDATE META LABELS
  //
  const visualNumber = records.length - index;
  document.getElementById(`${category}RecordIndex`).textContent =
    `Session ${visualNumber} of ${records.length}`;

  document.getElementById(`${category}RecordDate`).textContent =
    formatDate(record.date);

  // 3. UPDATE RATING CIRCLES
  const fields = Object.keys(record).filter(
    k => k !== "date" && k !== "media"
  );

  fields.forEach(field => {
    const circles = document.querySelectorAll(
      `#progress-${category} .rating-circles[data-field="${field}"] .circle`
    );

    circles.forEach(circle => {
      const level = Number(circle.dataset.level);

      // Always reset classes first
      circle.classList.remove("active-blue", "active-green");

      // Newest session ‚Üí blue
      if (index === 0) {
        if (record[field] === level) {
          circle.classList.add("active-blue");
        }
        circle.style.pointerEvents = "auto";
      }

      // Older sessions ‚Üí green + disabled
      else {
        if (record[field] === level) {
          circle.classList.add("active-green");
        }
        circle.style.pointerEvents = "none";
      }
    });
  });
  renderAttachments(category, record);
}

function renderAttachments(category, record) {
  if (!record.media) record.media = { attachments: [] };
  if (!record.media.attachments) record.media.attachments = [];
  
  const container = document.getElementById(`${category}Attachments`);
  container.innerHTML = "";

  const isEditable = progressState[category].index === 0;
  const count = record.media.attachments.length;

  const icon = document.createElement("img");
  icon.src = "icons/paperclip.svg";
  icon.className = "attachments-icon";

  const countEl = document.createElement("span");
  countEl.className = "attachments-count";

  if (count > 0) {
    countEl.textContent = count;
  } else if (isEditable) {
    countEl.textContent = "+";
  } else {
    container.classList.add("disabled");
  }

  container.appendChild(icon);
  container.appendChild(countEl);

  container.onclick = () => {
    if (isEditable) openAttachmentPicker(category);
    else openAttachmentViewer(record.media.attachments);
  };
}

function openAttachmentPicker(category) {
  console.log("Add attachment to", category);
  // open camera or file picker
}

function openAttachmentViewer(attachments) {
  console.log("View attachments:", attachments);
  // open modal/gallery
}

function initCircleListeners() {
  const allCircles = document.querySelectorAll(".rating-circles .circle");

  allCircles.forEach(circle => {
    circle.addEventListener("click", () => {
      const field = circle.parentElement.dataset.field;
      const level = Number(circle.dataset.level);

      // Only update if newest session
      const category = getCategoryFromElement(circle);
      const index = progressState[category].index;
      if (index !== 0) return;

      const player = players[current];
      const record = player.progress[category][0];

      record[field] = level;

      save();
      //updateAllPlayersView();
      renderProgressPanel(category);
    });
  });
}
function getCategoryFromElement(el) {
  const recordEl = el.closest(".progress-record");
  if (recordEl.id.includes("hitting")) return "hitting";
  if (recordEl.id.includes("fielding")) return "fielding";
  if (recordEl.id.includes("intangibles")) return "intangibles";
}

function formatDate(iso) {
  const d = new Date(iso);
  return d.toLocaleDateString("en-US", {
    month: "short",
    day: "numeric",
    year: "numeric"
  });
}

function capitalize(s) {
  return s.charAt(0).toUpperCase() + s.slice(1);
}

/* PROFILE PHOTO HANDLING */
document.getElementById("profilePicWrapper").addEventListener("click", () => {
  document.getElementById("photoInput").click();
});

document.getElementById("photoInput").addEventListener("change", function () {
  const file = this.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function (event) {
    const img = new Image();
    img.onload = function () {
      const canvas = document.createElement("canvas");
      const maxSize = 300; // compress to ~300px
      let width = img.width;
      let height = img.height;

      if (width > height) {
        if (width > maxSize) {
          height *= maxSize / width;
          width = maxSize;
        }
      } else {
        if (height > maxSize) {
          width *= maxSize / height;
          height = maxSize;
        }
      }

      canvas.width = width;
      canvas.height = height;

      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, width, height);

      const compressedData = canvas.toDataURL("image/jpeg", 0.7);

      players[current].photo = compressedData;
      save();
      loadPlayer();
    };
    img.src = event.target.result;
  };
  reader.readAsDataURL(file);
});

/* INITIALIZE */
renderTeamList();
initCircleListeners();
initProgressSwipeListeners();

function seedTeam(teamName) {
  const names = [
    "ILeiana Aguilar",
    "Jana Almasri",
    "Juliet Apodaca",
    "Alannah Arguello",
    "Shealey Belardes",
    "Alexis Berggren",
    "Katelyn Borecky",
    "Cambria Brosnan",
    "Angela Calixto",
    "Natalie Cervantes",
    "Penelope Cuevas",
    "Avery Dean",
    "Alyson Eden",
    "Adeline Esquivel",
    "Lily Esquivel",
    "Aryanna Fernandez",
    "Harper Flores",
    "Kaylee Flores",
    "Haley Franco",
    "Evelyn Gardino",
    "Maddison Garcia",
    "Cora Gottlieb",
    "Tavyn Green",
    "Jaedyn Kandyce Grill",
    "Leilani Hernandez",
    "Kara Hutchinson",
    "Lilyana Jordan",
    "Aria Lopez",
    "Bella Lopez",
    "Bianca Lopez",
    "Noelle Marquez",
    "Caroline McDonald",
    "Mila Medina",
    "Samantha Mendoza",
    "Dryden Miyajima",
    "Kennedy Moralez",
    "Madison Murphy",
    "Hannah Nack",
    "Leiyanah Paipa",
    "Victoria Parker",
    "Khloe Pettit",
    "Katalina Ponce",
    "Cierra Prieto",
    "Madison Pulver",
    "Aiyana Renteria",
    "Kaylee Rhodes",
    "Alysse Robles",
    "Daliah Sanchez",
    "Savannah Springsteen",
    "Riley Tanner",
    "Evelyn Tellez",
    "Isabel Torres",
    "Noshla Turner",
    "Uushla Turner",
    "Ariyana Ari Tyler",
    "Olivia Vallejos",
    "Stella Vega",
    "Amelia Webber",
    "Gloria Wiebel"
  ];

  const roster = names.map(n => ({ name: n }));

  const key = "team_" + teamName;
  localStorage.setItem(key, JSON.stringify(roster));

  alert("Team seeded: " + teamName);
}

</script>

</body>



